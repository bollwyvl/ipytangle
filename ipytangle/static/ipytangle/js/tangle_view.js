// Generated by CoffeeScript 1.9.2
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty,
    indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; },
    modulo = function(a, b) { return (+a % (b = +b) + b) % b; };

  define(["underscore", "jquery", "../lib/d3/d3.js", "backbone", "../lib/rangy/rangy-core.js", "widgets/js/widget", "base/js/events", "base/js/namespace"], function(_, $, d3, Backbone, rangy, widget, events, IPython) {
    var $win, TangleView;
    $win = $(window);
    return {
      TangleView: TangleView = (function(superClass) {
        extend(TangleView, superClass);

        function TangleView() {
          this.initVariableNumeric = bind(this.initVariableNumeric, this);
          this.initVariableChoices = bind(this.initVariableChoices, this);
          this.initVariable = bind(this.initVariable, this);
          this.updateVariable = bind(this.updateVariable, this);
          this.initIf = bind(this.initIf, this);
          this.getStackMatch = bind(this.getStackMatch, this);
          this.updateIf = bind(this.updateIf, this);
          this.updateEndIf = bind(this.updateEndIf, this);
          this.initEndIf = bind(this.initEndIf, this);
          this.updateOutput = bind(this.updateOutput, this);
          this.initOutput = bind(this.initOutput, this);
          this.onMarkdown = bind(this.onMarkdown, this);
          this.template = bind(this.template, this);
          return TangleView.__super__.constructor.apply(this, arguments);
        }

        TangleView.prototype.EVT = {
          MD: "rendered.MarkdownCell"
        };

        TangleView.prototype.RE_INTERPOLATE = /`(.+?)`/g;

        TangleView.prototype.render = function() {
          var cell, i, len, ref, results, view;
          TangleView.__super__.render.apply(this, arguments);
          view = this;
          this.templates = {};
          this.d3 = d3.select(this.el).classed({
            panel: 1,
            "panel-info": 1
          }).style({
            width: "100%"
          });
          this.heading = this.d3.append("div").classed({
            "panel-heading": 1
          });
          this.title = this.heading.append("h3").classed({
            "panel-title": 1
          });
          this.title.append("span").text("Tangle");
          this.title.append("button").classed({
            "pull-right": 1,
            btn: 1,
            "btn-link": 1
          }).style({
            "margin-top": 0,
            "padding": 0,
            height: "24px"
          }).on("click", (function(_this) {
            return function() {
              _this.model.set("_expanded", !_this.model.get("_expanded"));
              return _this.update();
            };
          })(this)).append("i").classed({
            fa: 1,
            "fa-fw": 1,
            "fa-ellipsis-h": 1,
            "fa-2x": 1
          });
          this.table = this.d3.append("table").classed({
            table: 1,
            "table-hover": 1
          });
          this.table.append("thead");
          this.table.append("tbody");
          events.on(this.EVT.MD, this.onMarkdown);
          this.update();
          ref = IPython.notebook.get_cells();
          results = [];
          for (i = 0, len = ref.length; i < len; i++) {
            cell = ref[i];
            results.push(this.onMarkdown(null, {
              cell: cell
            }));
          }
          return results;
        };

        TangleView.prototype.update = function() {
          var row, rows, view;
          TangleView.__super__.update.apply(this, arguments);
          view = this;
          rows = d3.entries(this.model.attributes).filter(function(attr) {
            return attr.key[0] !== "_";
          }).filter(function(attr) {
            var ref;
            return ref = attr.key, indexOf.call(view.model.attributes._tangle_upstream_traits, ref) < 0;
          });
          rows.sort(function(a, b) {
            return d3.ascending(a.key, b.key);
          });
          row = this.table.data([rows]).classed({
            hide: !this.model.get("_expanded")
          }).call(function() {
            var init;
            return init = this.enter();
          }).select("tbody").selectAll("tr").data(function(data) {
            return data;
          }).call(function() {
            var init;
            init = this.enter().append("tr");
            init.append("th");
            return init.append("td").style({
              width: "100%"
            }).append("input").classed({
              "form-control": 1
            }).on("input", function(arg) {
              var key, value;
              key = arg.key, value = arg.value;
              view.model.set(key, d3.select(this).property("value"));
              return view.touch();
            });
          });
          row.select("th").text(function(arg) {
            var key;
            key = arg.key;
            return key;
          });
          row.select("input").property({
            value: function(arg) {
              var value;
              value = arg.value;
              return value;
            }
          });
          return this;
        };

        TangleView.prototype.remove = function() {
          events.off(this.EVT.MD, this.onMarkdown);
          return TangleView.__super__.remove.apply(this, arguments);
        };

        TangleView.prototype.template = function(el) {
          var codes;
          codes = el.selectAll("code").each(function() {
            var src;
            src = this.textContent;
            return d3.select(this).datum(function() {
              return new Function("obj", "with(obj){return (" + src + ");}");
            });
          });
          return function(attributes) {
            return codes.text(function(fn) {
              return fn(attributes);
            });
          };
        };

        TangleView.prototype.nodeToConfig = function(el) {
          "implements the ipytangle URL minilanguage\n- `:` a pure output view\n- `<undecided_namespace>:some_variable`\n- `:if` and `:endif`";
          var config, expression, namespace, ref, template, values;
          ref = el.attr("href").slice(1).split(":"), namespace = ref[0], expression = ref[1];
          template = this.template(el);
          switch (expression) {
            case "":
              config = {
                type: "output",
                template: template
              };
              break;
            case "if":
            case "endif":
              config = {
                type: expression,
                template: template
              };
              break;
            default:
              config = {
                type: "variable",
                variable: expression,
                template: template
              };
              values = "_" + expression + "_choices";
              if (values in this.model.attributes) {
                config.choices = (function(_this) {
                  return function() {
                    return _this.model.get(values);
                  };
                })(this);
              }
          }
          return config || {};
        };

        TangleView.prototype.withType = function(selection, _type, handler) {
          return selection.filter(function(arg) {
            var type;
            type = arg.type;
            return type === _type;
          }).call(handler);
        };

        TangleView.prototype.onMarkdown = function(evt, arg) {
          var cell, found, tangles, view;
          cell = arg.cell;
          view = this;
          found = d3.select(cell.element[0]).selectAll("a[href^='#']:not(.tangle):not(.anchor-link)").each(function() {
            var it;
            it = d3.select(this);
            return it.datum(view.nodeToConfig(it));
          }).classed({
            tangle: 1
          });
          this.withType(found, "output", this.initOutput);
          this.withType(found, "variable", this.initVariable);
          this.withType(found, "if", this.initIf);
          this.withType(found, "endif", this.initEndIf);
          tangles = d3.select(cell.element[0]).selectAll(".tangle");
          this.withType(tangles, "output", this.updateOutput);
          this.withType(tangles, "variable", this.updateVariable);
          this.withType(tangles, "if", this.updateIf);
          return this.withType(tangles, "endif", this.updateEndIf);
        };

        TangleView.prototype.initOutput = function(field) {
          var view;
          view = this;
          return field.classed({
            tangle_output: 1
          }).style({
            "text-decoration": "none",
            color: "black"
          }).each(function(d) {
            var el;
            el = d3.select(this);
            return view.listenTo(view.model, "change", function() {
              return d.template(view.model.attributes);
            });
          });
        };

        TangleView.prototype.updateOutput = function(field) {
          return field.each((function(_this) {
            return function(d) {
              return d.template(_this.model.attributes);
            };
          })(this));
        };

        TangleView.prototype.initEndIf = function(field) {
          return field.classed({
            tangle_endif: 1
          });
        };

        TangleView.prototype.updateEndIf = function(field) {};

        TangleView.prototype.updateIf = function(field) {};

        TangleView.prototype.getStackMatch = function(elFor, pushSel, popSel) {
          var found, stack;
          stack = [];
          found = null;
          d3.selectAll("." + pushSel + ", ." + popSel).each(function() {
            var el, popped;
            if (found) {
              return;
            }
            el = d3.select(this);
            if (el.classed(pushSel)) {
              return stack.push(this);
            } else {
              popped = stack.pop();
              if (popped === elFor) {
                return found = this;
              }
            }
          });
          return found;
        };

        TangleView.prototype.initIf = function(field) {
          var view;
          view = this;
          return field.classed({
            tangle_if: 1
          }).each(function(d) {
            var el;
            el = d3.select(this);
            return view.listenTo(view.model, "change", function() {
              var nodes, range, show;
              show = "true" === d.template(view.model.attributes);
              range = rangy.createRange();
              range.setStart(el.node());
              d.end = d.end || view.getStackMatch(el.node(), "tangle_if", "tangle_endif");
              range.setEnd(d.end);
              nodes = d3.selectAll(range.getNodes());
              nodes.filter(function() {
                return this.nodeType === 3;
              }).each(function() {
                return $(this).wrap("<span></span>");
              });
              return nodes.filter(function() {
                return this.nodeType !== 3;
              }).classed({
                hide: !show
              });
            });
          });
        };

        TangleView.prototype.updateVariable = function(field) {
          var attributes;
          attributes = this.model.attributes;
          return field.each(function(arg) {
            var template;
            template = arg.template;
            return template(attributes);
          });
        };

        TangleView.prototype.initVariable = function(field) {
          var view;
          view = this;
          field.classed({
            tangle_variable: 1
          }).style({
            "text-decoration": "none",
            "border-bottom": "dotted 1px blue"
          }).each(function(arg) {
            var el, template, variable;
            variable = arg.variable, template = arg.template;
            el = d3.select(this);
            return view.listenTo(view.model, "change:" + variable, function() {
              return template(view.model.attributes);
            });
          });
          field.filter(function(arg) {
            var choices, variable;
            choices = arg.choices, variable = arg.variable;
            return !choices && typeof view.model.attributes[variable] === "number";
          }).call(this.initVariableNumeric);
          field.filter(function(arg) {
            var choices;
            choices = arg.choices;
            return choices;
          }).call(this.initVariableChoices);
          return field.each(this.tooltip);
        };

        TangleView.prototype.initVariableChoices = function(field) {
          return field.attr({
            title: "click"
          }).on("click", (function(_this) {
            return function(d) {
              var choices, old, old_idx;
              old = _this.model.get(d.variable);
              choices = d.choices();
              old_idx = choices.indexOf(old);
              _this.model.set(d.variable, choices[modulo(old_idx + 1, choices.length)]);
              return _this.touch();
            };
          })(this));
        };

        TangleView.prototype.initVariableNumeric = function(field) {
          var _touch, drag;
          _touch = _.debounce((function(_this) {
            return function() {
              return _this.touch();
            };
          })(this));
          drag = d3.behavior.drag().on("drag", (function(_this) {
            return function(d) {
              var old;
              old = _this.model.get(d.variable);
              _this.model.set(d.variable, d3.event.dx + old);
              return _touch();
            };
          })(this));
          return field.attr({
            title: "drag"
          }).style({
            cursor: "ew-resize"
          }).call(drag);
        };

        TangleView.prototype.tooltip = function() {
          return $(this).tooltip({
            placement: "bottom",
            container: "body"
          });
        };

        return TangleView;

      })(widget.WidgetView)
    };
  });

}).call(this);
